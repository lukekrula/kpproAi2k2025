<!DOCTYPE html>
<html>
<head>
    <title>GeoJSON Map with Layers</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        #map { height: 95vh; width: 100%; }
    </style>
</head>
<body>
<div id="map"></div>

<!-- Load Leaflet first -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Then proj4 and proj4leaflet -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.js"></script>

<script>
    const map = L.map("map").setView([50.2, 15.9], 8);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
    }).addTo(map);

    // Define S-JTSK projection for nature (EPSG:5514)
    const crs5514 = new L.Proj.CRS(
        "EPSG:5514",
        "+proj=krovak +lat_0=49.5 +lon_0=24.83333333333333 +alpha=30.28858 +k=0.9999 " +
        "+x_0=0 +y_0=0 +ellps=bessel +towgs84=570.69,85.69,462.84,4.998,1.586,5.261,3.56 +units=m +no_defs",
        { origin: [0, 0] }
    );

    // Loader function
    function loadLayer(url, options) {
        return fetch(url)
            .then(r => r.json())
            .then(data => {
                console.log("Loaded", url, "features:", data.features.length);
                return L.geoJSON(data, {
                    pointToLayer: (feature, latlng) => {
                        if (feature.properties && feature.properties.x != null && feature.properties.y != null) {
                            return L.marker([feature.properties.y, feature.properties.x], options.markerOptions);
                        }
                        return L.marker(latlng, options.markerOptions);
                    },
                    coordsToLatLng: coords => {
                        if (options.convert === "mercator3857") {
                            const p = L.Projection.SphericalMercator.unproject({ x: coords[0], y: coords[1] });
                            return L.latLng(p.lat, p.lng);
                        }
                        if (options.convert === "krovak5514") {
                            const p = crs5514.projection.unproject({ x: coords[0], y: coords[1] });
                            return L.latLng(p.lat, p.lng);
                        }
                        return L.latLng(coords[1], coords[0]);
                    },
                    style: feature => {
                        if (feature.geometry.type.includes("Polygon")) {
                            return options.style;
                        }
                    },
                    onEachFeature: (feature, layer) => {
                        let label = "Unnamed";

                        if (feature.properties) {
                            // Nature dataset
                            if (feature.properties.NAZEV) {
                                label = feature.properties.NAZEV;
                            }
                            // Region dataset
                            else if (feature.properties.nazev_obce) {
                                label = feature.properties.nazev_obce;
                            }
                            else if (feature.properties.nazev_vusc) {
                                label = feature.properties.nazev_vusc;
                            }
                            // Architecture dataset
                            else if (feature.properties.nazev) {
                                label = feature.properties.nazev;
                            }
                        }

                        const desc = feature.properties?.popis || feature.properties?.POZNAMKA || "";
                        layer.bindPopup(`<b>${label}</b><br>${desc}`);
                    }


                });
            });
    }

    Promise.all([
        // Architecture points
        loadLayer("http://localhost:8080/api/arch", {
            markerOptions: { icon: L.icon({
                    iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
                    shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
                    iconSize: [25, 41],
                    iconAnchor: [12, 41]
                }) }
        }),
        // Regions polygons (EPSG:3857)
        loadLayer("http://localhost:8080/api/region", {
            style: { color: "orange", weight: 2, fillColor: "#ffcc99", fillOpacity: 0.4 },
            convert: "mercator3857"
        }),
        // Nature polygons (EPSG:5514)
        loadLayer("http://localhost:8080/api/nature", {
            style: { color: "green", weight: 2, fillColor: "#99ff99", fillOpacity: 0.4 },
            convert: "krovak5514"
        })
    ]).then(([archLayer, regionsLayer, natureLayer]) => {
        archLayer.addTo(map);
        regionsLayer.addTo(map);
        natureLayer.addTo(map);

        // Zoom to Královéhradecký kraj region bounds
        if (regionsLayer.getBounds().isValid()) {
            map.fitBounds(regionsLayer.getBounds());
        } else {
            map.fitBounds(L.latLngBounds([49.9, 15.6], [50.6, 16.5]));
        }

        L.control.layers(null, {
            "Architecture": archLayer,
            "Regions": regionsLayer,
            "Nature": natureLayer
        }).addTo(map);
    }).catch(err => {
        console.error("Layer load error:", err);
    });
</script>
</body>
</html>
